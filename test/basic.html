<!doctype html>
<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>core-resizable tests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <link rel="import" href="../core-resizable.html">
  <style>
  </style>
</head>
<body fit>

<polymer-element name="core-resizer-parent">
  <script>
    Polymer(Polymer.mixin({
      eventDelegates: {
        'core-resize': 'resizeHandler'
      },
      attached: function() {
        this.resizerAttachedHandler();
      },
      detached: function() {
        this.resizerDetachedHandler();
      }
    }, Polymer.CoreResizer));
  </script>
</polymer-element>

<polymer-element name="core-resizer-parent-filtered" extends="core-resizer-parent">
  <script>
    Polymer({
      active: null,
      resizerShouldNotify: function(el) {
        return (el == this.active);
      }
    });
  </script>
</polymer-element>

<polymer-element name="core-resizer-peer" extends="core-resizer-parent">
  <script>
    Polymer({
      resizerIsPeer: true     
    });
  </script>
</polymer-element>

<polymer-element name="core-resizer-peer-filtered" extends="core-resizer-parent-filtered">
  <script>
    Polymer({
      resizerIsPeer: true     
    });
  </script>
</polymer-element>

<polymer-element name="core-resizable">
  <script>
    Polymer(Polymer.mixin({
      eventDelegates: {
        'core-resize': 'resizeHandler'
      },
      attached: function() {
        this.resizableAttachedHandler();
      },
      detached: function() {
        this.resizableDetachedHandler();
      }
    }, Polymer.CoreResizable));
  </script>
</polymer-element>

<polymer-element name="core-resizable-in-shadow" noscript>
  <template>
    <div>
      <core-resizable id="resizable"></core-resizable>
    </div>
  </template>
</polymer-element>

<polymer-element name='test-element' noscript>
  <template>

    <!-- Normal CoreResizer parent with child CoreResizables -->
    <core-resizer-parent id="parent">
      <core-resizable id="child1a"></core-resizable>
      <div>
        <core-resizable id="child1b"></core-resizable>
      </div>
      <core-resizable-in-shadow id="shadow1c"></core-resizable-in-shadow>
      <div>
        <core-resizable-in-shadow id="shadow1d"></core-resizable-in-shadow>
      </div>
    </core-resizer-parent>

    <!-- CoreResizer parent using shouldNotify, with child CoreResizables -->
    <core-resizer-parent-filtered id="parentFiltered">
      <core-resizable id="child2a"></core-resizable>
      <div>
        <core-resizable id="child2b"></core-resizable>
      </div>
      <core-resizable-in-shadow id="shadow2c"></core-resizable-in-shadow>
      <div>
        <core-resizable-in-shadow id="shadow2d"></core-resizable-in-shadow>
      </div>
    </core-resizer-parent-filtered>

    <!-- CoreResizer using resizerIsPeer:true, with peer CoreResizables -->
    <div>
      <core-resizable id="child3a"></core-resizable>
      <div>
        <core-resizable id="child3b"></core-resizable>
      </div>
      <core-resizer-peer id="peer"></core-resizer-peer>
      <core-resizable-in-shadow id="shadow3c"></core-resizable-in-shadow>
      <div>
        <core-resizable-in-shadow id="shadow3d"></core-resizable-in-shadow>
      </div>
    </div>

    <!-- CoreResizer using resizerIsPeer:true and shouldNotify, with peer CoreResizables -->
    <div>
      <core-resizable id="child4a"></core-resizable>
      <div>
        <core-resizable id="child4b"></core-resizable>
      </div>
      <core-resizer-peer-filtered id="peerFiltered"></core-resizer-peer-filtered>
      <core-resizable-in-shadow id="shadow4c"></core-resizable-in-shadow>
      <div>
        <core-resizable-in-shadow id="shadow4d"></core-resizable-in-shadow>
      </div>
    </div>

    <!-- Nested CoreResizers -->
    <core-resizer-parent id="parentTop">
      <core-resizer-parent id="parentNested">
        <core-resizable id="child5a"></core-resizable>
        <core-resizer-peer id="peerNested"></core-resizer-peer>
        <div>
          <core-resizable-in-shadow id="shadow5b"></core-resizable-in-shadow>
        </div>
      </core-resizer-parent>
    </core-resizer-parent>

  </template>

</polymer-element>

<test-element></test-element>

<script>

  document.addEventListener('polymer-ready', function() {

    var testEl = document.querySelector('test-element');

    var registered = [];
    var notifyPending = [];
    var registerResizeHandler = function(el, expectNotification) {
      registered.push(el);
      if (expectNotification !== false) {
        notifyPending.push(el);
      }
      el.resizeHandler = function() {
        var idx = notifyPending.indexOf(this);
        if (idx < 0) {
          debugger;
        }
        assert(idx >= 0, 'resize notified to unexpected resizable ' + this.localName + '#' + this.id);
        notifyPending.splice(idx, 1);
      }.bind(el);
    };
    var unregisterResizeHandlers = function() {
      registered.forEach(function(r) {
        r.resizeHandler = null;
      });
      registered = [];
      notifyPending = [];
    };

    suite('core-resizer-parent', function() {

      test('notify resizables from window', function() {
        registerResizeHandler(testEl.$.parent);
        registerResizeHandler(testEl.$.child1a);
        registerResizeHandler(testEl.$.child1b);
        registerResizeHandler(testEl.$.shadow1c.$.resizable);
        registerResizeHandler(testEl.$.shadow1d.$.resizable);
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('notify resizables from parent', function() {
        registerResizeHandler(testEl.$.parent);
        registerResizeHandler(testEl.$.child1a);
        registerResizeHandler(testEl.$.child1b);
        registerResizeHandler(testEl.$.shadow1c.$.resizable);
        registerResizeHandler(testEl.$.shadow1d.$.resizable);
        testEl.$.parent.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach resizables then notify parent', function() {
        registerResizeHandler(testEl.$.parent);
        registerResizeHandler(testEl.$.child1a, false);
        registerResizeHandler(testEl.$.child1b);
        registerResizeHandler(testEl.$.shadow1c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow1d.$.resizable);
        testEl.$.child1a.remove();
        testEl.$.shadow1c.remove();
        testEl.$.parent.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach parent then notify window', function() {
        registerResizeHandler(testEl.$.parent, false);
        registerResizeHandler(testEl.$.child1a, false);
        registerResizeHandler(testEl.$.child1b, false);
        registerResizeHandler(testEl.$.shadow1c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow1d.$.resizable, false);
        testEl.$.parent.remove();
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

    });

    suite('core-resizer-parent-filtered', function() {

      test('notify resizables from window', function() {
        registerResizeHandler(testEl.$.parentFiltered);
        registerResizeHandler(testEl.$.child2a);
        registerResizeHandler(testEl.$.child2b, false);
        registerResizeHandler(testEl.$.shadow2c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow2d.$.resizable, false);
        testEl.$.parentFiltered.active = testEl.$.child2a;
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('notify resizables from parent', function() {
        registerResizeHandler(testEl.$.parentFiltered);
        registerResizeHandler(testEl.$.child2a);
        registerResizeHandler(testEl.$.child2b, false);
        registerResizeHandler(testEl.$.shadow2c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow2d.$.resizable, false);
        testEl.$.parentFiltered.active = testEl.$.child2a;
        testEl.$.parentFiltered.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach resizables then notify parent', function() {
        registerResizeHandler(testEl.$.parentFiltered);
        registerResizeHandler(testEl.$.child2a, false);
        registerResizeHandler(testEl.$.child2b, false);
        registerResizeHandler(testEl.$.shadow2c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow2d.$.resizable);
        testEl.$.child2a.remove();
        testEl.$.shadow2c.remove();
        testEl.$.parentFiltered.active = testEl.$.shadow2d.$.resizable;
        testEl.$.parentFiltered.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach parent then notify window', function() {
        registerResizeHandler(testEl.$.parentFiltered, false);
        registerResizeHandler(testEl.$.child2a, false);
        registerResizeHandler(testEl.$.child2b, false);
        registerResizeHandler(testEl.$.shadow2c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow2d.$.resizable, false);
        testEl.$.parentFiltered.remove();
        testEl.$.parentFiltered.active = testEl.$.shadow2d.$.resizable;
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

    });

    suite('core-resizer-peer', function() {

      test('notify resizables from window', function() {
        registerResizeHandler(testEl.$.peer);
        registerResizeHandler(testEl.$.child3a);
        registerResizeHandler(testEl.$.child3b);
        registerResizeHandler(testEl.$.shadow3c.$.resizable);
        registerResizeHandler(testEl.$.shadow3d.$.resizable);
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('notify resizables from peer', function() {
        registerResizeHandler(testEl.$.peer);
        registerResizeHandler(testEl.$.child3a);
        registerResizeHandler(testEl.$.child3b);
        registerResizeHandler(testEl.$.shadow3c.$.resizable);
        registerResizeHandler(testEl.$.shadow3d.$.resizable);
        testEl.$.peer.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach resizables then notify', function() {
        registerResizeHandler(testEl.$.peer);
        registerResizeHandler(testEl.$.child3a, false);
        registerResizeHandler(testEl.$.child3b);
        registerResizeHandler(testEl.$.shadow3c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow3d.$.resizable);
        testEl.$.child3a.remove();
        testEl.$.shadow3c.remove();
        testEl.$.peer.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach peer then notify', function() {
        registerResizeHandler(testEl.$.peer);
        registerResizeHandler(testEl.$.child3a, false);
        registerResizeHandler(testEl.$.child3b);
        registerResizeHandler(testEl.$.shadow3c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow3d.$.resizable);
        testEl.$.peer.remove();
        testEl.$.peer.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

    });

    suite('core-resizer-peer-filtered', function() {

      test('notify resizables from window', function() {
        registerResizeHandler(testEl.$.peerFiltered);
        registerResizeHandler(testEl.$.child4a);
        registerResizeHandler(testEl.$.child4b, false);
        registerResizeHandler(testEl.$.shadow4c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow4d.$.resizable, false);
        testEl.$.peerFiltered.active = testEl.$.child4a;
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('notify resizables from peer', function() {
        registerResizeHandler(testEl.$.peerFiltered);
        registerResizeHandler(testEl.$.child4a);
        registerResizeHandler(testEl.$.child4b, false);
        registerResizeHandler(testEl.$.shadow4c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow4d.$.resizable, false);
        testEl.$.peerFiltered.active = testEl.$.child4a;
        testEl.$.peerFiltered.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach resizables then notify parent', function() {
        registerResizeHandler(testEl.$.peerFiltered);
        registerResizeHandler(testEl.$.child4a, false);
        registerResizeHandler(testEl.$.child4b, false);
        registerResizeHandler(testEl.$.shadow4c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow4d.$.resizable);
        testEl.$.child4a.remove();
        testEl.$.shadow4c.remove();
        testEl.$.peerFiltered.active = testEl.$.shadow4d.$.resizable;
        testEl.$.peerFiltered.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach peer then notify window', function() {
        registerResizeHandler(testEl.$.peerFiltered, false);
        registerResizeHandler(testEl.$.child4a, false);
        registerResizeHandler(testEl.$.child4b, false);
        registerResizeHandler(testEl.$.shadow4c.$.resizable, false);
        registerResizeHandler(testEl.$.shadow4d.$.resizable, false);
        testEl.$.peerFiltered.remove();
        testEl.$.peerFiltered.active = testEl.$.shadow4d.$.resizable;
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

    });

    suite('core-resizer-nested', function() {

      test('notify resizables from window', function() {
        registerResizeHandler(testEl.$.parentTop);
        registerResizeHandler(testEl.$.parentNested);
        registerResizeHandler(testEl.$.peerNested);
        registerResizeHandler(testEl.$.child5a);
        registerResizeHandler(testEl.$.shadow5b.$.resizable);
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('notify resizables from top parent', function() {
        registerResizeHandler(testEl.$.parentTop);
        registerResizeHandler(testEl.$.parentNested);
        registerResizeHandler(testEl.$.peerNested);
        registerResizeHandler(testEl.$.child5a);
        registerResizeHandler(testEl.$.shadow5b.$.resizable);
        testEl.$.parentTop.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('notify resizables from nested parent', function() {
        registerResizeHandler(testEl.$.parentTop, false);
        registerResizeHandler(testEl.$.parentNested);
        registerResizeHandler(testEl.$.peerNested);
        registerResizeHandler(testEl.$.child5a);
        registerResizeHandler(testEl.$.shadow5b.$.resizable);
        testEl.$.parentNested.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('notify resizables from nested peer', function() {
        registerResizeHandler(testEl.$.parentTop, false);
        registerResizeHandler(testEl.$.parentNested, false);
        registerResizeHandler(testEl.$.peerNested);
        registerResizeHandler(testEl.$.child5a);
        registerResizeHandler(testEl.$.shadow5b.$.resizable);
        testEl.$.peerNested.notifyResize();
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      // Known limitation: peers of detached `resizerIsPeer` won't be notified
      // by parent resizers; ROI on that bookkeeping not considered high enough
      test('detach peer then notify', function() {
        registerResizeHandler(testEl.$.parentTop);
        registerResizeHandler(testEl.$.parentNested);
        registerResizeHandler(testEl.$.peerNested, false);
        registerResizeHandler(testEl.$.child5a, false);
        registerResizeHandler(testEl.$.shadow5b.$.resizable, false);
        testEl.$.peerNested.remove();
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach resizables then notify', function() {
        registerResizeHandler(testEl.$.parentTop);
        registerResizeHandler(testEl.$.parentNested);
        registerResizeHandler(testEl.$.peerNested, false); // removed in above test
        registerResizeHandler(testEl.$.child5a, false);
        registerResizeHandler(testEl.$.shadow5b.$.resizable, false);
        testEl.$.child5a.remove();
        testEl.$.shadow5b.remove();
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

      test('detach top parent then notify', function() {
        registerResizeHandler(testEl.$.parentTop, false);
        registerResizeHandler(testEl.$.parentNested, false);
        registerResizeHandler(testEl.$.peerNested, false);
        registerResizeHandler(testEl.$.child5a, false);
        registerResizeHandler(testEl.$.shadow5b.$.resizable, false);
        testEl.$.parentTop.remove();
        window.dispatchEvent(new CustomEvent('resize', { bubbles: false }));
        assert(notifyPending.length === 0, 'all resizables were not notified');
        unregisterResizeHandlers();
      });

    });

  });

</script>

</body>
</html>
